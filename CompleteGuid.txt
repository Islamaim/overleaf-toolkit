# Complete Overleaf Setup Guide

## Overview
This guide provides step-by-step instructions for setting up Overleaf Community Edition with custom configuration, LaTeX packages, and proper user management.

## Prerequisites
- Ubuntu Linux system
- Git installed
- Docker and Docker Compose installed
- Sudo access
- At least 4GB RAM and 20GB free disk space

## Step 1: Clone the Repositories

# Navigate to your development directory
cd /home/islam/Documentos/Desarrollo/Overleaf

# Clone the main Overleaf repository
git clone https://github.com/Islamaim/overleaf.git

# Clone the overleaf-toolkit repository
git clone https://github.com/Islamaim/overleaf-toolkit.git

## Step 2: Install Docker and Docker Compose

# Update package list
sudo apt update

# Install Docker
sudo apt install -y docker.io docker-compose

# Start and enable Docker service
sudo systemctl start docker
sudo systemctl enable docker

# Add user to docker group
sudo usermod -aG docker $USER

# Install Docker Compose (newer version)
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Verify installations
docker --version
docker-compose --version

# Log out and back in for group changes to take effect
# Or run: newgrp docker

## Step 3: Create Data Directory

# Create the data directory
sudo mkdir -p /opt/overleaf
sudo chown -R 1000:1000 /opt/overleaf

## Step 4: Initialize Overleaf Toolkit

# Navigate to the toolkit directory
cd /home/islam/Documentos/Desarrollo/Overleaf/overleaf-toolkit

# Initialize the toolkit
./bin/init

## Step 5: Configure Overleaf Settings

### Configure overleaf.rc
# Edit the configuration file
nano config/overleaf.rc

Set the following values:
OVERLEAF_LISTEN_IP=0.0.0.0
OVERLEAF_PORT=81
OVERLEAF_DATA_DIR=/opt/overleaf

### Configure variables.env
# Edit the environment variables
nano config/variables.env

Set the following values:
OVERLEAF_APP_NAME="Our Overleaf Instance"

ENABLED_LINKED_FILE_TYPES=project_file,project_output_file

# Enables Thumbnail generation using ImageMagick
ENABLE_CONVERSIONS=true

# Disables email confirmation requirement
EMAIL_CONFIRMATION_DISABLED=true

# Disable user registration (admin must create accounts)
OVERLEAF_ALLOW_ANONYMOUS_REGISTRATION=false
OVERLEAF_DISABLE_REGISTRATION=true
OVERLEAF_REGISTRATION_DISABLED=true

OVERLEAF_SITE_URL=http://overleaf.lemuruniovi.es:80
OVERLEAF_NAV_TITLE=Our Overleaf Instance
OVERLEAF_ADMIN_EMAIL=islam@uniovi.es

## Step 6: Start Overleaf Services

# Start services in detached mode
sudo ./bin/up -d

# Check if services are running
sudo docker ps

# Wait for services to fully start (can take 1-2 minutes)
sleep 60

# Test the web interface
curl -I http://localhost:81

## Step 7: Create Admin User

# Create admin user
sudo docker exec -it sharelatex /bin/bash -c "cd /overleaf/services/web; node modules/server-ce-scripts/scripts/create-user.mjs --admin --email=admin@overleaf.local"

## Step 8: Install LaTeX Packages

### Update TeX Live Package Manager
sudo docker exec -it sharelatex bash -c "tlmgr update --self"

### Install Essential Packages
# Install datetime package (commonly missing)
sudo docker exec -it sharelatex bash -c "tlmgr install datetime"

# Install font collections
sudo docker exec -it sharelatex bash -c "tlmgr install collection-fontsrecommended"

# Install LaTeX extra packages
sudo docker exec -it sharelatex bash -c "tlmgr install collection-latexextra"

# Install math and science packages
sudo docker exec -it sharelatex bash -c "tlmgr install collection-mathscience"

# Install bibliography packages
sudo docker exec -it sharelatex bash -c "tlmgr install collection-bibtexextra"

### Install Additional Commonly Used Packages
# Install language support
sudo docker exec -it sharelatex bash -c "tlmgr install babel-french babel-german babel-spanish"

# Install math and units packages
sudo docker exec -it sharelatex bash -c "tlmgr install siunitx mathtools"

# Install algorithm and listing packages
sudo docker exec -it sharelatex bash -c "tlmgr install algorithm2e listings"

# Install bibliography packages
sudo docker exec -it sharelatex bash -c "tlmgr install natbib biblatex biber"

# Install table and figure packages
sudo docker exec -it sharelatex bash -c "tlmgr install tikz pgfplots xcolor url enumitem booktabs longtable array tabularx multirow colortbl"

# Install academic writing packages
sudo docker exec -it sharelatex bash -c "tlmgr install microtype setspace titlesec tocloft caption subcaption float placeins"

# Install cross-reference packages
sudo docker exec -it sharelatex bash -c "tlmgr install cleveref varioref footmisc lastpage"

# Install text formatting packages
sudo docker exec -it sharelatex bash -c "tlmgr install textcomp wasysym marvosym ulem soul"

# Install page layout packages
sudo docker exec -it sharelatex bash -c "tlmgr install geometry fancyhdr afterpage needspace"

## Step 9: Create Installation Scripts

### Essential LaTeX Packages Script
Create install_essential_latex.sh:
#!/bin/bash

echo "=========================================="
echo "Installing Essential LaTeX Packages"
echo "=========================================="

# Update tlmgr first
echo "Step 1: Updating tlmgr..."
sudo docker exec -it sharelatex bash -c "tlmgr update --self"

# Install the datetime package that was missing
echo "Step 2: Installing datetime package..."
sudo docker exec -it sharelatex bash -c "tlmgr install datetime"

# Install essential collections
echo "Step 3: Installing font collections..."
sudo docker exec -it sharelatex bash -c "tlmgr install collection-fontsrecommended"

echo "Step 4: Installing LaTeX extra packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install collection-latexextra"

echo "Step 5: Installing math and science packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install collection-mathscience"

echo "Step 6: Installing bibliography packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install collection-bibtexextra"

# Install commonly used individual packages
echo "Step 7: Installing commonly used packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install babel-french babel-german babel-spanish siunitx mathtools algorithm2e listings natbib biblatex biber"

echo "Step 8: Installing table and figure packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install tikz pgfplots xcolor url enumitem booktabs longtable array tabularx multirow colortbl"

echo "Step 9: Installing academic writing packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install microtype setspace titlesec tocloft caption subcaption float placeins"

echo "Step 10: Installing cross-reference packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install cleveref varioref footmisc lastpage"

echo "Step 11: Installing text formatting packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install textcomp wasysym marvosym ulem soul"

echo "Step 12: Installing page layout packages..."
sudo docker exec -it sharelatex bash -c "tlmgr install geometry fancyhdr afterpage needspace"

echo "=========================================="
echo "Essential LaTeX Package Installation Complete!"
echo "=========================================="
echo "The most commonly used LaTeX packages have been installed."
echo "Your document should now compile successfully."
echo "=========================================="

Make it executable:
chmod +x install_essential_latex.sh

## Step 10: Verify Installation

### Check Services Status
# Check if all containers are running
sudo docker ps

# Test web interface
curl -I http://localhost:81

### Test LaTeX Compilation
1. Access Overleaf at http://localhost:81
2. Log in with admin credentials
3. Create a test document with:
   \documentclass{article}
   \usepackage{datetime}
   \begin{document}
   Hello World!
   \today
   \end{document}
4. Compile to verify packages are working

## Step 11: User Management

### Create Additional Users
# Create regular user
sudo docker exec -it sharelatex /bin/bash -c "cd /overleaf/services/web; node modules/server-ce-scripts/scripts/create-user.mjs --email=user@example.com"

# Create admin user
sudo docker exec -it sharelatex /bin/bash -c "cd /overleaf/services/web; node modules/server-ce-scripts/scripts/create-user.mjs --admin --email=admin@example.com"

## Final Configuration Summary

- Data Directory: /opt/overleaf
- Port: 81
- URL: http://overleaf.lemuruniovi.es:80
- Admin Email: islam@uniovi.es
- Admin User: admin@overleaf.local
- User Registration: Disabled (admin creates accounts)
- LaTeX Packages: Comprehensive collection installed
- Email Confirmation: Disabled

## Troubleshooting

### If Services Don't Start
# Check logs
sudo docker logs sharelatex --tail 50

# Restart services
sudo ./bin/stop
sudo ./bin/up -d

### If LaTeX Packages Are Missing
# Install specific package
sudo docker exec -it sharelatex bash -c "tlmgr install [package-name]"

# Or run the installation script
./install_essential_latex.sh

### If You Get 502 Bad Gateway
# Wait for services to fully start (can take 1-2 minutes)
sleep 60
curl -I http://localhost:81

# Check if all containers are healthy
sudo docker ps

### If Registration is Still Enabled
# Check current settings
sudo docker exec -it sharelatex bash -c "grep -E 'REGISTRATION|ANONYMOUS' /etc/overleaf/settings.js"

# Restart services after configuration changes
sudo ./bin/stop
sudo ./bin/up -d

### If Data Directory Issues
# Check permissions
ls -la /opt/overleaf

# Fix permissions if needed
sudo chown -R 1000:1000 /opt/overleaf

## Maintenance Commands

### Start Services
sudo ./bin/up -d

### Stop Services
sudo ./bin/stop

### Restart Services
sudo ./bin/stop
sudo ./bin/up -d

### Update LaTeX Packages
sudo docker exec -it sharelatex bash -c "tlmgr update --all"

### Backup Data
# Backup the data directory
sudo tar -czf overleaf-backup-$(date +%Y%m%d).tar.gz /opt/overleaf

### Restore Data
# Restore from backup
sudo tar -xzf overleaf-backup-YYYYMMDD.tar.gz -C /

## Security Considerations

1. Firewall: Configure firewall to only allow necessary ports
2. SSL/TLS: Consider setting up SSL certificates for production use
3. Backups: Regular backups of /opt/overleaf directory
4. Updates: Regular updates of Docker images and LaTeX packages
5. Monitoring: Monitor disk space and system resources

## Next Steps

1. Set your admin password using the activation link
2. Create additional users as needed through admin interface
3. Upload and compile your LaTeX documents
4. Configure additional settings as required
5. Set up regular backups
6. Consider SSL/TLS setup for production use

## Support

- Admin Contact: islam@uniovi.es
- Documentation: Overleaf Community Edition Docs
- Issues: Check logs and troubleshooting section above

Your Overleaf instance is now fully functional with comprehensive LaTeX support and proper user management! 🎉